<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SystemTap: SystemTap Runtime Library</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<div class="qindex"><a class="qindex" href="index.html">Intro</a> | <a class="qindex" href="globals_func.html">Functions</a> | <a class="qindex" href="globals_defs.html">Defines</a> | <a class="qindex" href="globals_enum.html">Enumerations</a> | <a class="qindex" href="globals_eval.html">Enumeration Values</a></div>

<!-- Generated by Doxygen 1.4.1 -->
<h1>io.c</h1><a href="io_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
<a name="l00011"></a><a class="code" href="io_8c.html#a4">00011</a> <span class="keywordtype">void</span> <a class="code" href="io_8c.html#a4">dlog</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
00012 {
00013   va_list args;
00014   printk(<span class="stringliteral">"STP: "</span>);
00015   va_start(args, fmt);
00016   vprintk(fmt, args);
00017   va_end(args);
00018 }
00019 
00020 
00021 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * (*_stp_kallsyms_lookup)(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr,
00022                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *symbolsize,
00023                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *offset,
00024                             <span class="keywordtype">char</span> **modname, <span class="keywordtype">char</span> *namebuf)=(<span class="keywordtype">void</span> *)KALLSYMS_LOOKUP;
00025 
00026 
<a name="l00027"></a><a class="code" href="io_8c.html#a0">00027</a> <span class="preprocessor">#define STP_BUF_LEN 8191</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">/* FIXME. These need to be per-cpu */</span>
00030 <span class="keyword">static</span> <span class="keywordtype">char</span> _stp_pbuf[<a class="code" href="io_8c.html#a0">STP_BUF_LEN</a>+1];
00031 <span class="keyword">static</span> <span class="keywordtype">int</span> _stp_pbuf_len = <a class="code" href="io_8c.html#a0">STP_BUF_LEN</a>;
00032 
<a name="l00033"></a><a class="code" href="io_8c.html#a5">00033</a> <span class="keywordtype">void</span> <a class="code" href="io_8c.html#a5">_stp_print_buf</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
00034 {
00035   <span class="keywordtype">int</span> num;
00036   va_list args;
00037   <span class="keywordtype">char</span> *buf = _stp_pbuf + <a class="code" href="io_8c.html#a0">STP_BUF_LEN</a> - _stp_pbuf_len;
00038   va_start(args, fmt);
00039   num = vscnprintf(buf, _stp_pbuf_len, fmt, args);
00040   va_end(args);
00041   <span class="keywordflow">if</span> (num &gt; 0)
00042     _stp_pbuf_len -= num;
00043 }
00044 
<a name="l00045"></a><a class="code" href="io_8c.html#a6">00045</a> <span class="keywordtype">void</span> <a class="code" href="io_8c.html#a6">_stp_print_buf_init</a> (<span class="keywordtype">void</span>)
00046 {
00047   _stp_pbuf_len = <a class="code" href="io_8c.html#a0">STP_BUF_LEN</a>;
00048   _stp_pbuf[0] = 0;
00049 }
00050 
<a name="l00051"></a><a class="code" href="io_8c.html#a7">00051</a> <span class="keywordtype">void</span> <a class="code" href="io_8c.html#a7">_stp_print_symbol</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> address)
00052 {
00053         <span class="keywordtype">char</span> *modname;
00054         <span class="keyword">const</span> <span class="keywordtype">char</span> *name;
00055         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> offset, size;
00056         <span class="keywordtype">char</span> namebuf[KSYM_NAME_LEN+1];
00057 
00058         name = _stp_kallsyms_lookup(address, &amp;size, &amp;offset, &amp;modname, namebuf);
00059 
00060         <span class="keywordflow">if</span> (!name)
00061                 <a class="code" href="io_8c.html#a5">_stp_print_buf</a>(<span class="stringliteral">"0x%lx"</span>, address);
00062         <span class="keywordflow">else</span> {
00063           <span class="keywordflow">if</span> (modname)
00064             <a class="code" href="io_8c.html#a5">_stp_print_buf</a>(<span class="stringliteral">"%s+%#lx/%#lx [%s]"</span>, name, offset,
00065                            size, modname);
00066           <span class="keywordflow">else</span>
00067             <a class="code" href="io_8c.html#a5">_stp_print_buf</a>(<span class="stringliteral">"%s+%#lx/%#lx"</span>, name, offset, size);
00068         }
00069 }
00070 
00071  
<a name="l00072"></a><a class="code" href="io_8c.html#a8">00072</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="io_8c.html#a8">cur_ret_addr</a> (<span class="keyword">struct</span> pt_regs *regs)
00073 {
00074 <span class="preprocessor">#ifdef __x86_64__</span>
00075 <span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *ra = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)regs-&gt;rsp;
00076 <span class="preprocessor">#else</span>
00077 <span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *ra = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)regs-&gt;esp;
00078 <span class="preprocessor">#endif</span>
00079 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (ra)
00080     <span class="keywordflow">return</span> *ra;
00081   <span class="keywordflow">else</span>
00082     <span class="keywordflow">return</span> 0;
00083 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Mar 21 13:29:45 2005 for SystemTap by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
