// conversions tapset
// Copyright (C) 2005, 2006 Red Hat Inc.
//
// This file is part of systemtap, and is free software.  You can
// redistribute it and/or modify it under the terms of the GNU General
// Public License (GPL); either version 2, or (at your option) any
// later version.

function kernel_string:string (addr:long) %{ /* pure */
  char *destination = THIS->__retvalue;
  deref_string (destination, THIS->addr, MAXSTRINGLEN);
  goto success;
deref_fault: /* branched to from deref() */
  {
    static char errmsg[40];
    snprintf (errmsg, 40, "kernel string copy fault at 0x%p",
	 (void *) (uintptr_t) THIS->addr);
    CONTEXT->last_error = errmsg;
  }
success: ;
%}

# NB: accessing user space is hazardous from certain kernel contexts.
# Errors should be returned when this is detected.
function user_string:string (addr:long) %{ /* pure */
  long rc = _stp_strncpy_from_user (THIS->__retvalue, 
		 	            (const char __user*) (uintptr_t) THIS->addr,
				    MAXSTRINGLEN);
  if (rc < 0)
  {
    static char errmsg[40];
    snprintf (errmsg, 40, "user string copy fault at 0x%p",
	 (void *) (uintptr_t) THIS->addr);
   CONTEXT->last_error = errmsg;
  }
%}
