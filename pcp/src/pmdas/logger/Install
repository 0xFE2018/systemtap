#! /bin/sh
#
# Copyright (c) 1997 Silicon Graphics, Inc.  All Rights Reserved.
# Copyright (c) 2011 Red Hat Inc.
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
# 
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
#
# Install the logger PMDA and/or PMNS
#

# source the PCP configuration environment variables
. $PCP_DIR/etc/pcp.env

# Get the common procedures and variable assignments
#
. $PCP_SHARE_DIR/lib/pmdaproc.sh

# The name of the PMDA
#
iam=logger

# Using PMDA_INTERFACE_5.  But, pmdaproc.sh only handles 1-4.
#
pmda_interface=4

# Do it
#
pmdaSetup

# be careful that mortals cannot write any configuration files, as
# these would present a security problem
#
umask 022


# PMDA variables
#
configfile=""

_parsedefaults()
{
    echo "Extracting options from current installation ..."
    while getopts D:d:l c
    do
    	case $c in
	    \?)		echo "Warning: Unrecognized option in $PCP_PMCDCONF_PATH"
			echo "	       Remove line for the $iam PMDA in $PCP_PMCDCONF_PATH and re-run ./Install"
	    		exit 2;;
	    * )		;;
	esac
    done
    eval configfile='$'$OPTIND
    echo "_parsedefaults found $configfile"
}

# Get logfile(s) to monitor
if $do_pmda
then
    # set options from $PCP_PMCDCONF_PATH, if possible
    #
    ans=`$PCP_AWK_PROG <$PCP_PMCDCONF_PATH '
$1 == "'$iam'"	{ printf "%s",$6
		  for (i=7;i<=NF;i++) printf " %s",$i
		  print ""
	        }'`
    if [ ! -z "$ans" ]
    then
	_parsedefaults $ans
    fi

    # go figure out which configuration file to use ...
    #
    #default_configfile=./sample.conf
    default_configfile=''
    pmdaChooseConfigFile
    if [ ! -f "$configfile" ]
    then
	$PCP_ECHO_PROG $PCP_ECHO_N "Do you wish to enter logfile names manually? [y] ""$PCP_ECHO_C"
	read ans
	if [ "X$ans" = "Xy" -o "X$ans" = "XY" -o -z "$ans" ]
	then
	    configfile="$configdir/$iam.conf"
	    if [ -f $configfile ]
	    then
		    echo "Removing old configuration file \"$configfile\""
		    rm -f $configfile
		    if [ -f $configfile ]
		    then
			    echo "Cannot remove \"$configfile\""
			    _quit 1
		    fi
	    fi

	    echo
	    echo \
'Enter one logfile name per line.  An empty line terminates the
logfile selection process and there must be at least one logfile specified.
'

	    args=""
	    touch $configfile
	    if [ ! -f $configfile ]
	    then
		echo "Installation aborted."
		_quit 1
	    fi

	    while [ ! -s "$configfile" ]
	    do
		while true
		do
		    $PCP_ECHO_PROG $PCP_ECHO_N "Logfile name: ""$PCP_ECHO_C"
		    read logfile
		    [ -z "$logfile" ] && break
		    if grep "^$logfile$" $configfile >/dev/null
		    then
			echo "Sorry, logfile \"$logfile\" already specified.  Please try again."
			continue
		    fi
		    if [ ! -e "$logfile" ]; then
			echo "Error: logfile $value doesn't exist!  Reinstall to change."
		    fi
		    echo "$logfile" >>$configfile
		done
	    done
	else
	    echo ""
	    echo "Error: Abandoning installation as no configuration file was specified."
	    _quit 1
	fi
    fi

    args="$configfile"
fi

pmdaInstall

exit 0
