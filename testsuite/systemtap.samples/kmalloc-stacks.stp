global kmalloc_stack

function reset_maxaction () %{ 
        if (CONTEXT && CONTEXT->actioncount) 
                CONTEXT->actioncount=0; 
%} 

function write_output()
{
	foreach (stack in kmalloc_stack) {
		log("<hashkey>");
		print_stack(stack);
		log("</hashkey>");
		print("<hashval>");
		print(sprint(kmalloc_stack[stack]));
		log("</hashval>");
		reset_maxaction();
	}
}

probe timer.jiffies(5000)
{
	write_output();
	delete kmalloc_stack;
}

probe kernel.function("__kmalloc")
{
	kmalloc_stack[backtrace()]++; 
}

probe end
{
	write_output();
}
