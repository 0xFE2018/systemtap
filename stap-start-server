#!/bin/bash

# Start a systemtap server
#
# Copyright (C) 2008, 2009 Red Hat Inc.
#
# This file is part of systemtap, and is free software.  You can
# redistribute it and/or modify it under the terms of the GNU General
# Public License (GPL); either version 2, or (at your option) any
# later version.

# This script attempts to start a systemtap server and echoes the
# process id, if successful.

# INSTALL-HOOK These settings work for running the client from the source tree
# INSTALL-HOOK using the dejagnu test harness and will be overridden at install
# INSTALL-HOOK time.
exec_prefix=
sysconfdir=`pwd`/net

# start the server
${exec_prefix}stap-serverd "$@" </dev/null >/dev/null 2>&1 &
server_pid=$!

# Make sure the server is started
for ((attempt=0; $attempt < 10; ++attempt))
do
    if test $EUID = 0; then
	if ! test -f $sysconfdir/systemtap/ssl/server/stap-server.cert; then
	    sleep 1
	    continue;
	fi
    elif ! test -f $HOME/.systemtap/ssl/server/stap-server.cert; then
	sleep 1
	continue
    fi
    (ps -a | grep $server_pid) >/dev/null 2>&1 && echo $server_pid && exit 0
    sleep 1
done

exit 1 # server did not start
